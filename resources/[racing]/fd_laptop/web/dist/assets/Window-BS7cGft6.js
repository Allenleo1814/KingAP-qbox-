import{C as L,k as H,o as m,v as G,I as X,E as Y,H as q,J as j,a5 as P,a7 as U,K as Q,a8 as Z,a9 as ee,a6 as J,c as g,aa as te,ab as ie,G as ne,a4 as S,ac as ae,i as se,ad as oe,p as V,L as K,M as r,a as v,l as E,u as re,a2 as N,t as T,n as pe,O as de}from"./index-D8HCwQPV.js";import{s as le}from"./index-BqPJXKA4.js";import{u as ce}from"./connection.store-D6Y8DAQD.js";import"./index-DYfg_i5Y.js";const ue=L({__name:"InternalAppComponent",props:{app:{},metadata:{},appReady:{type:Function},changeWindowTitle:{type:Function}},setup(y){return(n,c)=>(m(),H(G(n.app.component),{appReady:n.appReady,changeWindowTitle:n.changeWindowTitle,metadata:n.metadata},null,8,["appReady","changeWindowTitle","metadata"]))}}),me=["src","frame-id","name"],fe=L({__name:"IframeAppComponent",props:{app:{},metadata:{},appReady:{type:Function},changeWindowTitle:{type:Function}},setup(y){const n=y,c=X(),w=Y(),x=q(),d=ce(),h=U("settings"),b=U("network"),i=j("iframe"),u=e=>{var t;i.value&&((t=i.value.contentWindow)==null||t.postMessage(e,"*"))},D=()=>{i.value&&u({action:`${n.app.id}:appData`,data:JSON.stringify(n.app)})},o=()=>{i.value&&u({action:`${n.app.id}:settings`,data:w.forApps})},O=()=>{i.value&&u({action:`${n.app.id}:network`,data:d.forApps})},W=()=>{i.value&&u({action:`${n.app.id}:devices`,data:JSON.stringify(c.installedDevices)})},A=e=>{i.value&&x.show(e)},k=()=>{var a,s;if(!i.value)return;const t=Object.entries({visibility:"visible",width:"100%",height:"100%",padding:0,margin:0}).map(([p,l])=>`${p}: ${l};`).join(" ");(a=i.value.contentDocument)==null||a.documentElement.setAttribute("style",t),(s=i.value.contentDocument)==null||s.body.setAttribute("style",t)},f=async()=>{i.value&&((n.app.onUse||n.app.onUseServer)&&await J("appOpened",{method:"POST",body:JSON.stringify({id:n.app.id})},void 0,null),I(),u({action:"onOpen",data:{}}),n.appReady(),k())},R=()=>{if(!i.value)return;const e={appReady:()=>f(),changeWindowTitle:t=>n.changeWindowTitle(t),getAppData:()=>D(),getSettings:()=>o(),getNetworkSettings:()=>O(),getDevices:()=>W(),sendNotification:t=>A(t)};te(i.value.contentWindow,"message",t=>{if(typeof t.data=="string")return e[t.data]?e[t.data](t.data):void 0;const{action:a,data:s}=t.data;e[a]&&e[a](s)})},_=()=>{var s;if(!i.value)return;const e=(s=i.value.contentWindow)==null?void 0:s.document.head;if(!e)return;n.app.overrides&&Array.isArray(n.app.overrides)&&n.app.overrides.forEach(p=>{const l=document.createElement("script");l.setAttribute("src",p),e.prepend(l)});const t=document.createElement("script");t==null||t.setAttribute("src",`https://cfx-nui-${ie}/web/dist/global.js`),e==null||e.prepend(t);const a=document.createElement("script");a.appendChild(document.createTextNode(`
        globalThis.resourceName = '${n.app.resourceName}'
        globalThis.appId = '${n.app.id}'
    `)),e==null||e.prepend(a)},B=()=>{var e;if(i.value)try{(e=i.value.contentWindow)==null||e.postMessage({action:"showMenu"},"*");const t=i.value.contentDocument||i.value.contentWindow.document,a=new MutationObserver(async s=>{let p=!1;s.forEach(l=>{l.addedNodes.length>0&&(p=!0)}),p&&(f(),a.disconnect())});a.observe(t.body,{childList:!0,subtree:!0})}catch(t){console.error("Error while loading external app:",t)}},M=()=>{if(!i.value)return;const e=()=>{var t;if((t=i.value.contentWindow)!=null&&t.Alpine){f();return}setTimeout(e,100)};e()},z=()=>{i.value&&(n.app.ui.includes("rahe-")||n.app.ui.includes("kub-")||n.app.isAlpine?M():n.app.isReactOrVue?B():setTimeout(f,1e3),R(),_())},I=()=>{n.app.ui.includes("rahe-")&&$(),n.app.ui.includes("kub_")&&C()},C=(e=!0)=>{var t,a,s,p;if((t=i.value.contentWindow)==null||t.postMessage({type:e?"showUI":"hideUI"},"*"),e){(s=((a=i.value.contentWindow)==null?void 0:a.document.body).lastElementChild)==null||s.setAttribute("style","position:relative; margin: 0; left: 0; top: 0; width: 100vw; height: 100vh; max-height: auto; max-width: auto; transform: none;");const F=((p=i.value.contentWindow)==null?void 0:p.document.head).appendChild(document.createElement("style"));F.setAttribute("type","text/css"),F.appendChild(document.createTextNode(".border-image { border-image: unset !important; } .ipad{border: unset !important;} .ipad::after{display:none !important;}"))}},$=(e=!0)=>{var t,a,s,p;if((t=i.value.contentWindow)==null||t.postMessage({action:e?"showMenu":"hideMenu"},"*"),e){const l=(a=i.value.contentWindow)==null?void 0:a.document.body;(s=l.firstElementChild)==null||s.setAttribute("style","position:relative; margin: 0; left: 0; top: 0; width: 100%; height: 100%;"),(p=l.getElementsByClassName("tablet-frame")[0])==null||p.remove()}};return P(async()=>{var e;h.on(t=>{var a;t==="updated"&&((a=i.value.contentWindow)==null||a.postMessage({action:"changedSettings",data:w.forApps},"*"))}),b.on(t=>{var a;t==="updated"&&((a=i.value.contentWindow)==null||a.postMessage({action:"networkChanged",data:d.forApps},"*"))}),Q("Escape",()=>{c.isOpen&&c.close(!0)},{target:(e=i.value.contentWindow)==null?void 0:e.window})}),Z("sendAppMessage",e=>{e.id===n.app.id&&u(e.message)}),ee(async()=>{n.app.ui.includes("rahe-")&&$(!1),n.app.ui.includes("kub-")&&C(!1),u({action:"closeApp"}),(n.app.onClose||n.app.onCloseServer)&&await J("appClosed",{method:"POST",body:JSON.stringify({id:n.app.id})},void 0,null)}),(e,t)=>(m(),g("iframe",{ref_key:"iframe",ref:i,src:e.app.ui,"frame-id":e.app.id,onload:z,name:e.app.id},null,8,me))}}),he={class:"mr-5 flex h-full max-w-96 items-center truncate px-2"},ve={class:"flex h-full items-center"},ge={key:0,class:"flex flex-1 items-center justify-center overflow-hidden"},we={class:"relative flex flex-1 overflow-hidden"},ke=L({__name:"Window",props:{appWindow:{},parent:{}},setup(y){const n=y,c=ne(),w=j("window"),x=j("toolbar"),{app:d,app:{windowActions:h},metadata:b,dimensions:i,position:[u,D],state:o}=n.appWindow,{parent:O}=n,W=S(i.width),A=S(i.height),k=S(d.name),f=S(!0),{x:R,y:_}=ae(w,{initialValue:{x:u,y:D},containerElement:O,preventDefault:!0,handle:x,disabled:!h.isDraggable,onMove(){o.isMaximized&&(o.isMaximized=!1)}}),B=se(()=>{const e={top:`${_.value}px`,left:`${R.value}px`,width:`${W.value}px`,minWidth:`${i.minWidth}px`,maxWidth:`${i.maxWidth}px`,height:`${A.value}px`,minHeight:`${i.minHeight}px`,maxHeight:`${i.maxHeight}px`,zIndex:20};return o.isMaximized&&(e.inset="0px",e.width="100%",e.height="100%",e.maxHeight="100%",e.maxWidth="100%"),!o.isMaximized&&h.isResizable&&(e.resize="both"),o.isActive&&(e.zIndex=40),e}),M=e=>{k.value=e},z=()=>{f.value=!1},I=()=>{c.toggleActiveState(d.id,!1),c.toggleMinimizeState(d.id,!0)},C=()=>{o.isMaximized=!o.isMaximized},$=()=>{c.close(d.id)};return P(async()=>{oe(w,e=>{const t=e[0],{width:a,height:s}=t.contentRect;o.isMaximized||o.isMinimized||(W.value=a,A.value=s)})}),(e,t)=>V((m(),g("div",{ref:"window",onClick:t[3]||(t[3]=N(a=>r(c).toggleActiveState(r(d).id,!0),["prevent"])),class:T(["absolute flex flex-1 flex-col overflow-hidden rounded-t-lg bg-gray-100/70 shadow-md backdrop-blur-xl dark:bg-gray-800/70",{"z-[100]":!r(o).isActive,"z-[999]":r(o).isActive}]),style:de(B.value)},[v("div",{class:"toolbar flex h-8 select-none items-center justify-between bg-gray-100/50 dark:bg-gray-900/50",ref_key:"toolbar",ref:x},[v("div",he,re(k.value??"-"),1),v("div",ve,[r(h).isMinimizable?(m(),g("button",{key:0,class:T(["flex h-full w-12 items-center justify-center text-neutral-500",["hover:bg-white hover:bg-opacity-5 hover:text-white"]]),type:"button",onClick:t[0]||(t[0]=N(a=>I(),["prevent"]))},t[4]||(t[4]=[v("i",{class:"pi pi-minus text-xs"},null,-1)]))):E("",!0),r(h).isMaximizable?(m(),g("button",{key:1,class:T(["flex h-full w-12 items-center justify-center text-neutral-500",["hover:bg-white hover:bg-opacity-5 hover:text-white"]]),type:"button",onClick:t[1]||(t[1]=N(a=>C(),["prevent"]))},[v("i",{class:T(["pi text-xs",r(o).isMaximized?"pi-window-minimize":"pi-window-maximize"])},null,2)])):E("",!0),r(h).isClosable?(m(),g("button",{key:2,onClick:t[2]||(t[2]=N(a=>$(),["prevent"])),class:"flex h-full w-12 items-center justify-center text-neutral-500 hover:bg-red-600 hover:text-white",type:"button"},t[5]||(t[5]=[v("i",{class:"pi pi-times text-xs"},null,-1)]))):E("",!0)])],512),f.value?(m(),g("div",ge,[pe(r(le))])):E("",!0),V(v("div",we,[r(d).isInternal?(m(),H(ue,{key:0,app:r(d),metadata:r(b),appReady:z,changeWindowTitle:M,class:"flex flex-1 overflow-hidden"},null,8,["app","metadata"])):(m(),H(fe,{key:1,app:r(d),metadata:r(b),appReady:z,changeWindowTitle:M,class:"flex flex-1 overflow-hidden"},null,8,["app","metadata"]))],512),[[K,!f.value]])],6)),[[K,!r(o).isMinimized&&!n.appWindow.isHidden]])}});export{ke as default};
